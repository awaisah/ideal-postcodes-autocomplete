/**
 * ideal-postcodes-autocomplete - Frontend UK Address Autocomplete Library for Ideal Postcodes API
 * @version v0.1.0
 * @link https://ideal-postcodes.co.uk
 * @license MIT
 */

var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Autocomplete;!function(t){var e;!function(t){t.create=function(t,e){var n=document.createElement(t);for(var r in e){var o=e[r];if("inside"===r){var i="string"==typeof o?document.querySelector(o):o;i.appendChild(n)}else if("around"===r){var s="string"==typeof o?document.querySelector(o):o;s.parentNode.insertBefore(n,s),n.appendChild(s)}else void 0!==n[r]?n[r]=o:n.setAttribute(r,o)}return n},t.addClass=function(t,e){var n=t.className.split(" ");return n.some(function(t){return t===e})?t:(n.push(e),t.className=n.join(" ").trim(),t)},t.removeClass=function(t,e){var n=t.className.split(" ");return t.className=n.filter(function(t){return t!==e}).join(" ").trim(),t},t.toArray=function(t){return"string"==typeof t?t.split(","):t},t.removeOrganisation=function(t){return 0===t.organisation_name.length?t:(t.line_1===t.organisation_name&&(t.line_1=t.line_2,t.line_2=t.line_3,t.line_3=""),t)}}(e=t.Utils||(t.Utils={}))}(Autocomplete||(Autocomplete={}));var Autocomplete;!function(t){var e=t.Utils.create,n=function(){function n(t){this.initialiseInterface(t).initialiseCallbacks(t).initialiseEventListeners(t).refresh()}return n.prototype.initialiseInterface=function(t){return this.suggestions=[],this.highlightIndex=-1,this.input=document.querySelector(t.inputField),this.input.setAttribute("autocomplete","off"),this.input.setAttribute("aria-autocomplete","list"),this.container=e("div",{className:"idpc_autocomplete",around:this.input}),this.suggestionList=e("ul",{className:"hidden idpc_ul",inside:this.container}),this},n.prototype.initialiseCallbacks=function(e){var n=this,r=function(){};return t.interfaceCallbacks.forEach(function(t){n[t]=e[t]?e[t]:r}),this},n.prototype.initialiseEventListeners=function(t){return this.input.addEventListener("input",this._onInput.bind(this)),this.input.addEventListener("blur",this._onBlur.bind(this,"blur")),this.input.addEventListener("focus",this._onFocus.bind(this)),this.input.addEventListener("keydown",this._onKeyDown.bind(this)),this.suggestionList.addEventListener("mousedown",this._onMousedown.bind(this)),this},n.prototype._onBlur=function(){this.onBlur(),this.close("blur")},n.prototype._onFocus=function(){this.onFocus(),this.refresh()},n.prototype._onInput=function(t){this.onInput(t)},n.prototype._onMousedown=function(t){var e=this.suggestionList,n=t.target;if(n!==e){for(;n&&!/li/i.test(n.nodeName);)n=n.parentNode;n&&0===t.button&&(t.preventDefault(),this.select(n))}},n.prototype._onKeyDown=function(t){var e=t.keyCode;this.opened()&&(13===e&&this.selected()?(t.preventDefault(),this.select()):8===e?this.onInput(t):27===e?this.close("esc"):38!==e&&40!==e||(t.preventDefault(),this[38===e?"previous":"next"]()))},n.prototype.detach=function(){return this.container.removeChild(this.suggestionList),this.container.parentElement.removeChild(this.container),this.container=null,this.suggestionList=null,this},n.prototype.setMessage=function(t){return void 0===t||0===t.length?this.refresh():(this.highlightIndex=-1,this.suggestionList.innerHTML="",this.suggestionList.appendChild(e("li",{innerHTML:t,"class":"idpc_error"})),this.open(),this)},n.prototype.refresh=function(){var t=this,n=this.suggestions;return this.highlightIndex=-1,this.suggestionList.innerHTML="",n.forEach(function(n){t.suggestionList.appendChild(e("li",{innerHTML:n.suggestion,"aria-selected":"false"}))}),0===this.suggestionList.children.length?this.close():this.open(),this},n.prototype.setSuggestions=function(t){return this.suggestions=t,this.refresh(),this},n.prototype.close=function(e){return this.opened()?(this.onClose(),t.Utils.addClass(this.suggestionList,"hidden"),this):this},n.prototype.open=function(){return this.onOpen(),t.Utils.removeClass(this.suggestionList,"hidden"),this},n.prototype.opened=function(){return!this.suggestionList.className.split(" ").some(function(t){return"hidden"===t})},n.prototype.next=function(){var t=this.suggestionList.children.length;return this["goto"](this.highlightIndex<t-1?this.highlightIndex+1:0)},n.prototype.previous=function(){var t=this.suggestionList.children.length;return 0!==this.highlightIndex&&this.selected()?this["goto"](this.highlightIndex-1):this["goto"](t-1)},n.prototype.scrollToView=function(t){var e=t.offsetTop,n=this.suggestionList.scrollTop;e<n&&(this.suggestionList.scrollTop=e);var r=this.suggestionList.clientHeight,o=t.clientHeight;return e+o>n+r&&(this.suggestionList.scrollTop=e-r+o),this},n.prototype["goto"]=function(t){var e=this.suggestionList.children;if(0===e.length)return this;this.selected()&&e[this.highlightIndex].setAttribute("aria-selected","false"),this.highlightIndex=t;var n=e[t];return t>-1&&e.length>0?(n.setAttribute("aria-selected","true"),this.scrollToView(n)):this.scrollToView(e[0]),this},n.prototype.select=function(t){if(t){var e=void 0;for(e=0;t=t.previousElementSibling;e++);this.highlightIndex=e}return this.highlightIndex>-1&&this.highlightIndex<this.suggestions.length&&(this.onSelect(this.suggestions[this.highlightIndex]),this.close("select")),this},n.prototype.selected=function(){return this.highlightIndex>-1},n}();t.Interface=n,t.interfaceCallbacks=["onOpen","onBlur","onClose","onFocus","onInput","onSelect"]}(Autocomplete||(Autocomplete={}));var IdealPostcodes;!function(t){t.API_URL="api.ideal-postcodes.co.uk",t.TLS=!0,t.VERSION="v1",t.DEFAULT_TIMEOUT=1e4,t.STRICT_AUTHORISATION=!1}(IdealPostcodes||(IdealPostcodes={})),window.IdealPostcodes=IdealPostcodes;var IdealPostcodes;!function(t){var e;!function(t){t.now=function(){return Date.now()},t.debounce=function(e,n){function r(){var c=t.now()-u;c>0&&c<n?o=setTimeout(r,n-c):(o=null,a=e.apply(s,i),o||(s=i=null))}void 0===n&&(n=100);var o,i,s,u,a;return function(){return s=this,i=arguments,u=t.now(),o||(o=setTimeout(r,n)),a}},t.extend=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=e.length,o=0;o<r;o++){var i=e[o];for(var s in i)void 0!==i[s]&&(t[s]=i[s])}return t}}(e=t.Utils||(t.Utils={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e=function(){function t(){this.store={postcodeStore:{},addressStore:{},autocompleteStore:{},udprnStore:{},umprnStore:{}}}return t.prototype.cacheAddressQuery=function(t,e){this.store.addressStore[t]=e},t.prototype.getAddressQuery=function(t){return this.store.addressStore[t]},t.prototype.cachePostcodeQuery=function(t,e){this.store.postcodeStore[t]=e},t.prototype.getPostcodeQuery=function(t){return this.store.postcodeStore[t]},t.prototype.cacheAutocompleteQuery=function(t,e){this.store.autocompleteStore[t]=e},t.prototype.getAutocompleteQuery=function(t){return this.store.autocompleteStore[t]},t.prototype.cacheUdprnQuery=function(t,e){this.store.udprnStore[t]=e},t.prototype.getUdprnQuery=function(t){return this.store.udprnStore[t]},t.prototype.cacheUmprnQuery=function(t,e){this.store.umprnStore[t]=e},t.prototype.getUmprnQuery=function(t){return this.store.umprnStore[t]},t}();t.Cache=e}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(t){t.blankRe=/^\s*$/,t.AllowedAuthorizationParameters=["api_key"],t.detectTls=function(t){try{return"http:"!==t.location.protocol}catch(e){return!0}},t.isIE=function(t){var e=t?t:window.navigator;try{var n=e.userAgent.toLowerCase();return n.indexOf("msie")!==-1&&parseInt(n.split("msie")[1])}catch(r){return!1}},t.generateQueryString=function(t){var e=[];for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},t.constructHeaders=function(e){var n={};return n.Authorization=t.constructAuthenticationHeader(e),n},t.deconstructAuthenticationHeader=function(t){var e={};return t?(t.replace("IDEALPOSTCODES ","").trim().split(" ").forEach(function(t){var n=t.split("=");"string"==typeof n[0]&&"string"==typeof n[1]&&(e[n[0]]=n[1].replace(/(^"|"$)/g,""))}),e):e},t.constructAuthenticationHeader=function(e){for(var n=[],r=0;r<t.AllowedAuthorizationParameters.length;r++){var o=t.AllowedAuthorizationParameters[r];void 0!==e[o]&&n.push(o+'="'+e[o]+'"')}return 0===n.length?"":"IDEALPOSTCODES "+n.join(" ")},t.constructQueryString=function(t){var e={};return t.filter&&(e.filter=t.filter.join(",")),t.licensee&&(e.licensee=t.licensee),t.tags&&(e.tags=t.tags.join(",")),e},t.constructAutocompleteQueryString=function(t){var e={};return e.query=t.query,e},t.constructAddressQueryString=function(t){var e={};return e.query=t.query,e.page=t.page||0,e.limit=t.limit||10,e}}(e=t.Transport||(t.Transport={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.message="Ideal Postcodes Error: "+e.message}return __extends(e,t),e}(Error);t.IdealPostcodesError=e;var n=function(t){function e(){t.call(this,{message:"Unable to parse JSON response"})}return __extends(e,t),e}(e);t.JsonParseError=n}(e=t.Errors||(t.Errors={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(t){t.parse=function(e){var r=e.status;if(200!==r){switch(r){case 503:return new n}try{return t.parseErrorResponse(JSON.parse(e.responseText),r)}catch(o){return new t.JsonParseError}}},t.parseErrorResponse=function(t,n){var r=t.code,i=t.message;return void 0===r||void 0===i?new o:new e({responseCode:r,status:n,message:i})};var e=function(t){function e(e){t.call(this,e),e.status&&(this.status=e.status),e.responseCode&&(this.responseCode=e.responseCode)}return __extends(e,t),e}(t.IdealPostcodesError);t.IdealPostcodesApiError=e;var n=function(t){function e(){t.call(this,{status:503,message:"Rate Limit Reached. Please wait a while before you retry your request"})}return __extends(e,t),e}(e);t.RateLimitError=n;var r=function(t){function e(){t.call(this,{message:"Request timed out"})}return __extends(e,t),e}(e);t.RequestTimeoutError=r;var o=function(t){function e(){t.call(this,{message:"Unknown AJAX error occurred when accessing API"})}return __extends(e,t),e}(e);t.GenericApiError=o}(e=t.Errors||(t.Errors={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(e){e.getXhr=function(){try{return new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0")}catch(t){return null}},e.xhrRequest=function(n,r){var o=n.url,i=e.generateQueryString(n.queryString);i.length>0&&(o+="?"+i);var s=e.getXhr();s.open(n.method,o,!0);try{for(var u in n.headers)s.setRequestHeader(u,n.headers[u])}catch(a){}var c=setTimeout(function(){s.onreadystatechange=function(){},s.abort(),r(new Error("Request timeout"),null,s)},n.timeout);return s.onreadystatechange=function(){var n;if(4===s.readyState){if(clearTimeout(c),200!==s.status)return r(t.Errors.parse(s),{},s);try{n=e.blankRe.test(s.responseText)?{}:JSON.parse(s.responseText)}catch(o){return r(new Error("parsererror"),null,s)}return r(null,n,s)}},s.send(n.data),s}}(e=t.Transport||(t.Transport={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(e){var n=0,r=function(){},o=function(n,r){n.queryString.callback=r;var o=n.headers,i=e.deconstructAuthenticationHeader(o.Authorization);return t.Utils.extend(n.queryString,i),e.generateQueryString(n.queryString)},i=function(t){var e=t.code;return e&&"number"==typeof e?parseInt(String(e).slice(0,3)):500};e.jsonpRequest=function(e,s){n+=1;var u=e.url;if(e.method&&"get"!==e.method.toLowerCase())return s(new Error("Browser is unable to perform non-GET requests"),null,null),null;var a="idpc_"+t.Utils.now()+"_"+n,c=o(e,a);c.length>0&&(u+="?"+c);var l=document.getElementsByTagName("script")[0]||document.head,h=setTimeout(function(){d(),s(new Error("Request timeout"),null,null)},e.timeout),d=function(){p.parentNode&&p.parentNode.removeChild(p),window[a]=r,h&&clearTimeout(h)};window[a]=function(e){d();var n=i(e),r={responseText:e,status:n};return 200!==r.status?s(t.Errors.parseErrorResponse(e,n),null,r):s(null,e,r)};var p=document.createElement("script");return p.src=u,p.type="text/javascript",l.parentNode.insertBefore(p,l),null}}(e=t.Transport||(t.Transport={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e;!function(e){e.defaultHeaders={Accept:"text/javascript, application/javascript"},e.request=function(n,r){var o={url:n.url,method:n.method||"GET",headers:n.headers||{},queryString:n.queryString||{},timeout:n.timeout||t.DEFAULT_TIMEOUT,data:n.data||null};return t.Utils.extend(o.headers,e.defaultHeaders),e.isIE()&&e.isIE()<10?e.jsonpRequest(o,r):e.xhrRequest(o,r)}}(e=t.Transport||(t.Transport={}))}(IdealPostcodes||(IdealPostcodes={}));var IdealPostcodes;!function(t){var e=t.Utils.extend,n=t.Transport,r=n.constructHeaders,o=n.constructQueryString,i=n.constructAddressQueryString,s=n.constructAutocompleteQueryString,u=function(){function n(e){var n=this;void 0===e&&(e={}),this.api_key=e.api_key,this.tls=void 0===e.tls?t.TLS:e.tls,this.version=void 0===e.version?t.VERSION:e.version,this.baseUrl=void 0===e.baseUrl?t.API_URL:e.baseUrl,this.strictAuthorisation=void 0===e.strictAuthorisation?t.STRICT_AUTHORISATION:e.strictAuthorisation,this.cache=new t.Cache;var r=this;this.autocompleteCallback=function(){},this.debouncedAutocomplete=t.Utils.debounce(function(t){n.lookupAutocomplete(t,r.autocompleteCallback)})}return n.prototype.apiUrl=function(){return"http"+(this.tls?"s":"")+"://"+this.baseUrl+"/"+this.version},n.prototype.ping=function(e){t.Transport.request({url:"http"+(this.tls?"s":"")+"://"+this.baseUrl},e)},n.prototype.lookupPostcode=function(e,n){var i=this;e.api_key=this.api_key;var s=r(e),u=o(e),a=e.postcode,c=this.cache.getPostcodeQuery(a);return c?n(null,c):void t.Transport.request({url:this.apiUrl()+"/postcodes/"+encodeURIComponent(e.postcode),headers:s,queryString:u},function(t,e,r){return t&&4040===t.responseCode?n(null,[],r):t?n(t,null,r):(i.cache.cachePostcodeQuery(a,e.result),n(null,e.result,r))})},n.prototype.lookupAddress=function(n,s){var u=this;n.api_key=this.api_key;var a=r(n),c=o(n);e(c,i(n));var l=n.query,h=this.cache.getAddressQuery(l);return h?s(null,h):void t.Transport.request({url:this.apiUrl()+"/addresses",headers:a,queryString:c},function(t,e,n){return t?s(t,null,n):(u.cache.cacheAddressQuery(l,e.result),s(null,e.result,n))})},n.prototype.lookupAutocomplete=function(n,i){var u=this;n.api_key=this.api_key;var a=r(n),c=o(n);e(c,s(n));var l=n.query,h=this.cache.getAutocompleteQuery(l);return h?i(null,h):(this.strictAuthorisation||(c.api_key=this.api_key,delete a.Authorization),void t.Transport.request({url:this.apiUrl()+"/autocomplete/addresses",headers:a,queryString:c},function(t,e,n){return t?i(t,null,n):(u.cache.cacheAutocompleteQuery(l,e.result),i(null,e.result,n))}))},n.prototype.lookupUdprn=function(e,n){var i=this;e.api_key=this.api_key;var s=r(e),u=o(e),a=e.id,c=this.cache.getUdprnQuery(a);return c?n(null,c):void t.Transport.request({url:this.apiUrl()+"/udprn/"+a,headers:s,queryString:u},function(t,e,r){return t?n(t,null,r):(i.cache.cacheUdprnQuery(a,e.result),n(null,e.result,r))})},n.prototype.lookupUmprn=function(e,n){var i=this;e.api_key=this.api_key;var s=r(e),u=o(e),a=e.id,c=this.cache.getUmprnQuery(a);return c?n(null,c):void t.Transport.request({url:this.apiUrl()+"/umprn/"+a,headers:s,queryString:u},function(t,e,r){return t?n(t,null,r):(i.cache.cacheUmprnQuery(a,e.result),n(null,e.result,r))})},n.prototype.checkKeyUsability=function(e,n){t.Transport.request({url:this.apiUrl()+"/keys/"+this.api_key,queryString:o(e)},function(t,e,r){return t?n(t,null,r):n(null,e.result,r)})},n.prototype.autocompleteAddress=function(t){this.debouncedAutocomplete(t)},n.prototype.registerAutocompleteCallback=function(t){this.autocompleteCallback=t},n}();t.Client=u}(IdealPostcodes||(IdealPostcodes={})),void 0!==window.IdealPostcodes&&(window.IdealPostcodes.Autocomplete=Autocomplete);var Autocomplete;!function(t){var e=function(){function e(t){this.inputField=t.inputField,this.checkKey=t.checkKey,this.removeOrganisation=t.removeOrganisation,this.configureApiRequests(t),this.initialiseClient(t),this.initialiseOutputFields(t.outputFields),this.initialiseCallbacks(t),this.initialiseInterface(t)}return e.prototype.configureApiRequests=function(t){var e=this;this.options={};var n=["licensee","filter","tags"];n.forEach(function(n){void 0!==t[n]&&(e.options[n]=t[n])})},e.prototype.initialiseClient=function(t){this.client=new IdealPostcodes.Client(t)},e.prototype.initialiseOutputFields=function(e){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=t.Utils.toArray(e[r]));this.outputFields=n},e.prototype.initialiseCallbacks=function(t){var e=function(){};this.onOpen=t.onOpen||e,this.onBlur=t.onBlur||e,this.onClose=t.onClose||e,this.onFocus=t.onFocus||e,this.onInput=t.onInput||e,this.onLoaded=t.onLoaded||e,this.onSearchError=t.onSearchError||e,this.onFailedCheck=t.onFailedCheck||e,this.onAddressSelected=t.onAddressSelected||e,this.onAddressRetrieved=t.onAddressRetrieved||e,this.onSuggestionsRetrieved=t.onSuggestionsRetrieved||e},e.prototype.initialiseInterface=function(t){var e=this;this.checkKey?this.client.checkKeyUsability(this.options,function(n,r){r.available?e.attachInterface(t):e.onFailedCheck.call(e)}):this.attachInterface(t)},e.prototype._onInterfaceInput=function(){var t=this;return function(e){t.onInput&&t.onInput(e),t["interface"].setMessage(),t.client.autocompleteAddress({query:this.input.value})}},e.prototype._onInterfaceSelect=function(){var e=this;return function(n){var r=this;e.onAddressSelected.call(this,n),e["interface"].setMessage();var o=function(n,o){return n?(e["interface"].setMessage("Unable to retrieve your address. Please enter your address manually"),e.onSearchError(n)):(e.onAddressRetrieved.call(r,o),e.removeOrganisation&&(o=t.Utils.removeOrganisation(o)),void e.populateAddress(o))},i=IdealPostcodes.Utils.extend({},this.options);n.umprn?(i.id=n.umprn,e.client.lookupUmprn(i,o)):(i.id=n.udprn,e.client.lookupUdprn(i,o))}},e.prototype.attachInterface=function(e){var n=this,r=this,o={inputField:e.inputField,onInput:r._onInterfaceInput(),onSelect:r._onInterfaceSelect()};t.interfaceCallbacks.forEach(function(t){o[t]||e[t]&&(o[t]=e[t])}),r["interface"]=new t.Interface(o),r.client.registerAutocompleteCallback(function(t,e){if(t)return r["interface"].setMessage("Unable to retrieve address suggestions. Please enter your address manually"),r.onSearchError(t);var o=e.hits;n.onSuggestionsRetrieved.call(n,o),r["interface"].setSuggestions(o)}),this.onLoaded.call(this)},e.prototype.detachInterface=function(){this["interface"]&&this["interface"].detach()},e.prototype.populateAddress=function(t){var e=this.outputFields,n=function(n){e.hasOwnProperty(n)&&e[n].forEach(function(e){for(var r=document.querySelectorAll(e),o=0;o<r.length;o++){var i=r[o];"string"==typeof i.value&&(i.value=t[n])}})};for(var r in e)n(r)},e}();t.Controller=e}(Autocomplete||(Autocomplete={}));